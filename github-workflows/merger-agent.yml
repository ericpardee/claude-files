name: Merger Agent

on:
  # Run on-demand
  workflow_dispatch:
  # Run every hour (can adjust frequency)
  schedule:
    - cron: '0 * * * *'
  # Run when a PR is labeled 'ready-to-merge'
  pull_request:
    types: [labeled]

jobs:
  merge-ready-prs:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find and merge ready PRs
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;

            // Find all PRs with 'ready-to-merge' label
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              per_page: 100
            });

            const readyPRs = prs.filter(pr =>
              pr.labels.some(label => label.name === 'ready-to-merge')
            );

            if (readyPRs.length === 0) {
              console.log('No PRs ready to merge');
              return;
            }

            console.log(`Found ${readyPRs.length} PRs ready to merge`);

            // Process PRs one at a time
            for (const pr of readyPRs) {
              console.log(`\nProcessing PR #${pr.number}: ${pr.title}`);

              // Check if PR is mergeable
              const { data: prDetails } = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: pr.number
              });

              // mergeable can be: true, false, or null (still calculating)
              if (prDetails.mergeable === null) {
                console.log(`  â³ Mergeable status still calculating, skipping for now`);
                continue;
              }

              if (prDetails.mergeable === false) {
                console.log(`  âŒ PR has merge conflicts`);

                // Remove 'ready-to-merge' label and add 'merge-conflict'
                await github.rest.issues.removeLabel({
                  owner,
                  repo,
                  issue_number: pr.number,
                  name: 'ready-to-merge'
                }).catch(() => {});

                await github.rest.issues.addLabels({
                  owner,
                  repo,
                  issue_number: pr.number,
                  labels: ['merge-conflict']
                });

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: `âš ï¸ **Merge conflict detected**

            This PR cannot be automatically merged due to conflicts with the base branch.

            **Options:**
            1. **Manual resolution**: Resolve conflicts locally and push
            2. **Rebase**: Rebase this branch on latest main
            3. **Request help**: Mention a maintainer for assistance

            Once conflicts are resolved, the merger agent will retry automatically.

            ðŸ¤– Merger Agent
            `
                });

                continue;
              }

              // Only merge when all required checks pass (mergeable_state === 'clean')
              if (prDetails.mergeable_state !== 'clean') {
                console.log(`  â³ Mergeable state: ${prDetails.mergeable_state}, waiting for all checks to pass`);
                continue;
              }

              // Merge the PR!
              console.log(`  âœ… Merging PR #${pr.number}`);

              try {
                await github.rest.pulls.merge({
                  owner,
                  repo,
                  pull_number: pr.number,
                  commit_title: `${pr.title} (#${pr.number})`,
                  commit_message: `Auto-merged by Merger Agent\n\nResolves #${pr.number}`,
                  merge_method: 'squash'  // or 'merge' or 'rebase'
                });

                // Comment on success
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: `âœ… **Auto-merged successfully**

            This PR passed all checks and was automatically merged by the Merger Agent.

            ðŸ¤– Merger Agent
            `
                });

                console.log(`  âœ… Successfully merged PR #${pr.number}`);

                // Close the linked issue
                // Extract issue number from PR body (format: "Resolves #123")
                const issueMatch = pr.body?.match(/Resolves #(\d+)/);
                if (issueMatch) {
                  const issueNumber = parseInt(issueMatch[1]);
                  await github.rest.issues.update({
                    owner,
                    repo,
                    issue_number: issueNumber,
                    state: 'closed',
                    state_reason: 'completed'
                  });
                  console.log(`  âœ… Closed issue #${issueNumber}`);
                }

              } catch (error) {
                console.log(`  âŒ Failed to merge: ${error.message}`);

                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: pr.number,
                  body: `âŒ **Auto-merge failed**

            Error: ${error.message}

            Please merge manually or investigate the issue.

            ðŸ¤– Merger Agent
            `
                });
              }

              // Add delay between merges to avoid race conditions
              await new Promise(resolve => setTimeout(resolve, 5000));
            }

            console.log('\nâœ… Merger agent finished');
